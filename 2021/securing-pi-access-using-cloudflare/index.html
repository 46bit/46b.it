<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://fonts.googleapis.com/css?family=Merriweather:400,700" rel="stylesheet">
  <link href="/assets/main.css?build=2021-10-02T14-19" rel="stylesheet">
  <link rel="canonical" href="https://46b.it/2021/securing-pi-access-using-cloudflare/">
  <link rel="alternate" type="application/rss+xml" title="46b.it" href="/meta/feed.atom">

  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-22921213-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-22921213-1');
  </script>
  <!-- $if(math)$
  <script src="/js/mathjax/MathJax.js?config=46bit"></script>
  $endif$ -->

  <title>Securing Raspberry Pi access using free CloudFlare - 46b.it</title>
</head>
<body>
  <header id="header">
    <div class="wrapper">
      <h1><a href="/"><img src="/assets/logo.png" alt="46b.it" width="75"></a></h1>
      <nav>
        
        <ul>
          <li ><a href="/art/">art</a></li>
          <li class="active"><a href="/writing/">writing</a></li>
          <li><a href="https://github.com/46bit">github</a></li>
          <li><a href="https://twitter.com/46bit">twitter</a></li>
        </ul>
      </nav>
    </div>
  </header>
  <article>
  <header class="prelude">
    <div class="wrapper">
      <p class="meta">September 8, 2021</p>
      
      <h1>Securing Raspberry Pi access using free CloudFlare</h1>
      
    </div>
  </header>
  <section class="wrapper">
    <p>I’ve recently been building an environment monitoring station at home using a Raspberry Pi 4B+. It turns out to be a remarkably powerful computer, much more than I remembered from earlier versions. I’ll write more another time about the environment side of things, but today I’m going to focus on how awesome the UX is when putting it behind Cloudflare.
<!--more--></p>

<p>This is the first time I’ve used <a href="https://www.cloudflare.com/">Cloudflare</a> for more than DNS, and it’s remarkable how much you can do for free. When I SSH to <code class="language-plaintext highlighter-rouge">pi.46bit.cloud</code>, I get redirected to a browser page to sign in – either with a one-time password emailed to me, or via Google OAuth. Only once that’s done can I actually finish SSHing. Cloudflare hides my actual home IP address and adds a strong boundary around accessing services externally.</p>

<p><img src="/assets/writing/cloudflare-access-otp.jpg" alt="The login page that Cloudflare Teams provides" /></p>

<h2 id="how-to-set-it-up">How to set it up</h2>

<p>You have to be hosting your DNS with Cloudflare for this to work. Once that’s done there are two parts to this:</p>

<ol>
  <li><strong>Connecting your host to Cloudflare:</strong> <a href="https://www.cloudflare.com/products/tunnel/">Argo Tunnel</a> connection outbound from my Pi to Cloudflare. This acts as a reverse proxy. Cloudflare forwards authenticated traffic to the Pi through this</li>
  <li><strong>Setup inside Cloudflare:</strong> A DNS entry pointing to a hostname identifying that tunnel, and then a <a href="https://www.cloudflare.com/teams/access/">Cloudflare Access</a> app telling Cloudflare what authentication to require.</li>
</ol>

<p>Setting up Argo Tunnel involves manual sysadmin on your Pi. Cloudflare provide <a href="https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/tunnel-guide">good instructions on setting up the tunnel</a>. You have to do this before proceeding further.</p>

<p>Once you’ve set up Argo Tunnel, Cloudflare Access can be setup in Cloudflare’s web interface. It’s exposed in their interface in a few different places and easier to configure in code using Terraform. Here’s how to do it with the <a href="https://registry.terraform.io/providers/cloudflare/cloudflare/latest/docs">Cloudflare Terraform Provider</a>:</p>

<div class="language-terraform highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">variable</span> <span class="s2">"cloudflare_account_id"</span> <span class="p">{</span>
  <span class="nx">description</span> <span class="p">=</span> <span class="s2">"Provide your Cloudflare account ID (a 20-ish character string)"</span>
<span class="p">}</span>

<span class="c1"># Change `46bit.cloud` to the name of your domain (DNS must be hosted in free Cloudflare)</span>
<span class="k">resource</span> <span class="s2">"cloudflare_zone"</span> <span class="s2">"_46bit_cloud"</span> <span class="p">{</span>
  <span class="nx">zone</span> <span class="p">=</span> <span class="s2">"46bit.cloud"</span>
  <span class="nx">plan</span> <span class="p">=</span> <span class="s2">"free"</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"cloudflare_record"</span> <span class="s2">"pi"</span> <span class="p">{</span>
  <span class="nx">zone_id</span> <span class="p">=</span> <span class="nx">cloudflare_zone</span><span class="p">.</span><span class="nx">_46bit_cloud</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">type</span>    <span class="p">=</span> <span class="s2">"CNAME"</span>
  <span class="nx">proxied</span> <span class="p">=</span> <span class="kc">true</span>

  <span class="c1"># Change `pi` to the subdomain you want to use</span>
  <span class="nx">name</span>  <span class="p">=</span> <span class="s2">"pi"</span>
  <span class="c1"># Change this to reflect the ID of your Argo Tunnel</span>
  <span class="nx">value</span> <span class="p">=</span> <span class="s2">"GUID-GOES-HERE.cfargotunnel.com"</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"cloudflare_access_application"</span> <span class="s2">"pi"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="p">=</span> <span class="s2">"pi"</span>
  <span class="nx">account_id</span> <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">cloudflare_account_id</span>

  <span class="c1"># Change this to the subdomain you want to use</span>
  <span class="nx">domain</span>           <span class="p">=</span> <span class="s2">"pi.46bit.cloud"</span>
  <span class="c1"># Change this to `self_hosted` if this is a webapp rather than SSH</span>
  <span class="nx">type</span>             <span class="p">=</span> <span class="s2">"ssh"</span>
  <span class="nx">session_duration</span> <span class="p">=</span> <span class="s2">"24h"</span>

  <span class="nx">allowed_idps</span> <span class="p">=</span> <span class="p">[</span><span class="nx">cloudflare_access_identity_provider</span><span class="p">.</span><span class="nx">email_an_otp_to_login</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
  <span class="nx">auto_redirect_to_identity</span> <span class="p">=</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"cloudflare_access_policy"</span> <span class="s2">"pi_email"</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="p">=</span> <span class="s2">"Pi SSH access via email"</span>
  <span class="nx">account_id</span> <span class="p">=</span> <span class="kd">var</span><span class="p">.</span><span class="nx">cloudflare_account_id</span>

  <span class="nx">application_id</span> <span class="p">=</span> <span class="nx">cloudflare_access_application</span><span class="p">.</span><span class="nx">pi</span><span class="p">.</span><span class="nx">id</span>
  <span class="nx">precedence</span> <span class="p">=</span> <span class="s2">"1"</span>
  <span class="nx">decision</span>   <span class="p">=</span> <span class="s2">"allow"</span>

  <span class="nx">include</span> <span class="p">{</span>
    <span class="c1"># Change this to your email address domain</span>
    <span class="nx">email_domain</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"46b.it"</span><span class="p">,</span> <span class="s2">"46bit.com"</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">resource</span> <span class="s2">"cloudflare_access_identity_provider"</span> <span class="s2">"email_an_otp_to_login"</span> <span class="p">{</span>
  <span class="nx">account_id</span> <span class="p">=</span> <span class="kd">local</span><span class="p">.</span><span class="nx">cloudflare_account_id</span>
  <span class="nx">name</span>       <span class="p">=</span> <span class="s2">"Email a One Time Password to login"</span>
  <span class="nx">type</span>       <span class="p">=</span> <span class="s2">"onetimepin"</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now visiting the domain will require you to be able to access an email account on that domain before you can proceed. For automatic access you can use <a href="https://registry.terraform.io/providers/cloudflare/cloudflare/latest/docs/resources/access_service_token">Service Tokens</a> (sadly mTLS isn’t supported in the free plan.)</p>

  </section>
  <div class="wrapper prev-next-jump">
    
      <a class="prev" href="/2021/choosing-to-focus-as-a-software-engineer/">&larr; Choosing a technical focus as a software engineer</a>
    
    
      <a class="next" href="/2021/built-an-rts-in-the-browser/">I built a real-time strategy game in the browser &rarr;</a>
    
  </div>
<article>

</body>
</html>
