<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://fonts.googleapis.com/css?family=Merriweather:400,700" rel="stylesheet">
  <link href="/assets/main.css?build=2021-10-21T03-16" rel="stylesheet">
  <link rel="canonical" href="https://46b.it/2021/getting-alerted-when-cycle-paths-flood-part-two/">
  <link rel="alternate" type="application/rss+xml" title="46b.it" href="/meta/feed.atom">

  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-22921213-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-22921213-1');
  </script>
  <!-- $if(math)$
  <script src="/js/mathjax/MathJax.js?config=46bit"></script>
  $endif$ -->

  <title>Getting alerted when cycle paths flood: part two - 46b.it</title>
</head>
<body>
  <header id="header">
    <div class="wrapper">
      <h1><a href="/"><img src="/assets/logo.png" alt="46b.it" width="75"></a></h1>
      <nav>
        
        <ul>
          <li ><a href="/art/">art</a></li>
          <li class="active"><a href="/writing/">writing</a></li>
          <li><a href="https://github.com/46bit">github</a></li>
          <li><a href="https://twitter.com/46bit">twitter</a></li>
        </ul>
      </nav>
    </div>
  </header>
  <article>
  <header class="prelude">
    <div class="wrapper">
      <p class="meta">March 5, 2021</p>
      
      <h1>Getting alerted when cycle paths flood: part two</h1>
      
    </div>
  </header>
  <section class="wrapper">
    <p>I recently moved back to York, a city I absolutely love. One of the best things about living here is cycling. But York has two rivers, one of which brings rain from hills a long way away. Some of the best cycle routes can flood after rainfall when the rivers rise.
<!--more--></p>

<p>This post is aimed is at software engineers with DevOps skills who already run Prometheus and Grafana. If you don’t have those skills then I’d be interested in figuring out how to make this more widely available–contact me.</p>

<p>In <strong><a href="/2021/getting-alerted-when-cycle-paths-flood/">the first post</a></strong> I explained how to get River Water Level data exposed in a way that Prometheus can scrape. In this post we’ll get Prometheus scraping the data, and then look at how we can get alerts and see the data in Grafana.</p>

<h2 id="scraping-river-water-levels-into-prometheus">Scraping river water levels into Prometheus</h2>

<p>I have deployed the <code class="language-plaintext highlighter-rouge">flood-exporter</code> we built in <a href="/2021/getting-alerted-when-cycle-paths-flood/">my last post</a>, and it’s running at <code class="language-plaintext highlighter-rouge">flood-exporter.46bit.cloud</code>. You can also run it yourself using the example manifests in <a href="https://github.com/46bit/flood-exporter">github.com/46bit/flood-exporter</a>.</p>

<p>Scraping this endpoint into Prometheus is simple (since I’m very familiar with Prometheus.) Here’s the YAML config:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scrape_configs:
- job_name: river_level_metrics
  scheme: https
  static_configs:
  - targets:
    - flood-exporter.46bit.cloud
  metrics_path: /probe
  scrape_interval: 180s
  params:
    target:
      - https://environment.data.gov.uk/flood-monitoring/id/stations/L2406.json
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">https://environment.data.gov.uk/flood-monitoring/id/stations/L2406.json</code> is specific to York. See <a href="/2021/getting-alerted-when-cycle-paths-flood/">the previous post</a> to understand how to get river data for a different place.</p>

<p>This should “just work” :)</p>

<p>There are three metrics available:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">river_level_measurement</code>, storing the current river level in metres</li>
  <li><code class="language-plaintext highlighter-rouge">river_level_min_on_record</code>, storing the lowest river level that’s been measured</li>
  <li><code class="language-plaintext highlighter-rouge">river_level_miaxon_record</code>, storing the highest river level that’s been measured</li>
</ul>

<p>In York the river level is updated every 15 minutes, so the Prometheus config only bothers to scrape every few minutes. I don’t know if it’s different elsewhere.</p>

<h2 id="building-a-dashboard-in-grafana">Building a dashboard in Grafana</h2>

<p>Now that the data’s in Prometheus, we’re free to use it in a Grafana dashboard.</p>

<p>Some of the Grafana dashboard is going to be specific to York, but I’ll give you my config and you can tune it to your needs.</p>

<p>The river levels used for these alerts are from <a href="http://nosearmy.com/isitflooded/">nosearmy.com/isitflooded/</a>. All credit to them.</p>

<p>Here’s what my dashboard looks like when things are OK:</p>

<p><a href="/assets/writing/york-cycle-path-dashboard-happy.png"><img src="/assets/writing/york-cycle-path-dashboard-happy.png" alt="A Grafana dashboard showing that the River Ouse is low and there are no flooded cycle paths" /></a></p>

<p>Here’s what my dashboard looks like when there’s a flood (only simulated as there hasn’t been one since I deployed this):</p>

<p><a href="/assets/writing/york-cycle-path-dashboard-flooding.png"><img src="/assets/writing/york-cycle-path-dashboard-flooding.png" alt="A Grafana dashboard showing that the River Ouse is high and there are several deeply flooded cycle paths" /></a></p>

<p>The really cool thing about this is that the right-hand side panel tells me how deeply paths are flooded. On a bicycle I can go through a few centimetres, but not 20 or 30cm.</p>

<p>You can get the source code for my Grafana dashboard at <a href="https://gist.github.com/46bit/a05a6d5bd1f2dc9a4bdfa0c87d328452">gist.github.com/46bit/a05a6d5bd1f2dc9a4bdfa0c87d328452</a>. Install it into your Grafana and it should just work, provided you’ve got Prometheus scraping the data.</p>

<h2 id="setting-up-alerts">Setting up alerts</h2>

<p>I’m using <a href="https://grafana.com/products/cloud/">Grafana Cloud</a> to run my Grafana, so it’s easier to use Grafana Alerts than to configure Alertmanager.</p>

<p>The Grafana dashboard above includes a bunch of alerts for each of the different paths. I’ve got them forwarding messages to a <code class="language-plaintext highlighter-rouge">#cycling</code> channel in York-specific Slack group that I’m in:</p>

<p><img src="/assets/writing/york-cycle-path-slack-alert.png" alt="A Slack message posted by Grafana to warn that a York cycle path is flooded" /></p>

<p>Rather than trying to teach you how to use Grafana Alerts, install my dashboard and tweak it for your purposes. Expand the <code class="language-plaintext highlighter-rouge">Path flood alerts</code> row at the bottom of the dashboard and you can edit the alerts in there.</p>

  </section>
  <div class="wrapper prev-next-jump">
    
      <a class="prev" href="/2021/getting-alerted-when-cycle-paths-flood/">&larr; Getting alerted when cycle paths flood</a>
    
    
      <a class="next" href="/2021/choosing-to-focus-as-a-software-engineer/">Choosing a technical focus as a software engineer &rarr;</a>
    
  </div>
<article>

</body>
</html>
